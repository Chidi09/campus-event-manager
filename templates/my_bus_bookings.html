{% extends "base.html" %}

{% block title %}My Bus Booking Requests{% endblock %}

{% block content %}
    <h2>My Bus Booking Requests</h2>

    {% if bookings %}
        <table border="1" style="width:100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
                <tr>
                    <th style="padding: 8px; text-align: left;">Bus Identifier</th>
                    <th style="padding: 8px; text-align: left;">Requested Date</th>
                    <th style="padding: 8px; text-align: left;">Pickup Time</th>
                    <th style="padding: 8px; text-align: left;">From</th>
                    <th style="padding: 8px; text-align: left;">To</th>
                    <th style="padding: 8px; text-align: left;">Purpose</th>
                    <th style="padding: 8px; text-align: left;">Passengers</th>
                    <th style="padding: 8px; text-align: left;">Submitted</th>
                    <th style="padding: 8px; text-align: left;">Status</th>
                    <th style="padding: 8px; text-align: left;">Admin Remarks</th>
                    <th style="padding: 8px; text-align: left;">Ticket</th> {# NEW COLUMN #}
                </tr>
            </thead>
            <tbody>
                {% for booking in bookings %}
                <tr>
                    <td style="padding: 8px;">{{ booking.bus.identifier if booking.bus else 'N/A' }}</td>
                    <td style="padding: 8px;">{{ booking.requested_date.strftime('%Y-%m-%d') }}</td>
                    <td style="padding: 8px;">{{ booking.pickup_time.strftime('%H:%M') }}</td>
                    <td style="padding: 8px;">{{ booking.pickup_location }}</td>
                    <td style="padding: 8px;">{{ booking.destination }}</td>
                    <td style="padding: 8px;">{{ booking.purpose | truncate(30) }}</td>
                    <td style="padding: 8px;">{{ booking.number_of_passengers if booking.number_of_passengers else 'N/A' }}</td>
                    <td style="padding: 8px;">{{ booking.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td style="padding: 8px;">
                        <strong 
                            {% if booking.status == 'Approved' %} style="color: green;"
                            {% elif booking.status == 'Rejected' or booking.status == 'Cancelled by Admin' %} style="color: red;"
                            {% elif booking.status == 'Pending' %} style="color: orange;"
                            {% else %} style="color: dimgray;" %}{# For other statuses like Cancelled by Student #}
                            {% endif %}>
                            {{ booking.status }}
                        </strong>
                    </td>
                    <td style="padding: 8px;">{{ booking.admin_remarks if booking.admin_remarks else '-' }}</td>
                    <td style="padding: 8px;"> {# NEW CELL FOR TICKET DOWNLOAD #}
                        {% if booking.status == 'Approved' and booking.certificate_path %}
                            <a href="{{ url_for('download_certificate', file_path=booking.certificate_path) }}" target="_blank" style="color: #007bff;">Download Ticket</a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="margin-top: 20px;">You have not made any bus booking requests yet.</p>
        <p><a href="{{ url_for('list_buses') }}">Click here to view available buses and make a booking.</a></p>
    {% endif %}

    <p style="margin-top: 30px;">
        <a href="{{ url_for('dashboard') }}">Back to Dashboard</a>
    </p>
{% endblock %}
